<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiddleClaw</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root { --font-body: 'Outfit', sans-serif; --font-mono: 'DM Mono', monospace; --radius: 12px; --radius-sm: 8px; --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
  [data-theme="light"] {
    --bg-base: #C8C8C8; --bg-surface: #FFFFFF; --bg-surface-hover: #D4D4D4; --bg-inset: #B8B8B8;
    --bg-chat-user: #D4D4D4; --bg-chat-assistant: transparent; --border: #9E9E9E; --border-subtle: #B8B8B8;
    --text-primary: #1A1917; --text-secondary: #6B7280; --text-tertiary: #9CA3AF;
    --accent: #e63946; --accent-hover: #d62828; --accent-subtle: #ffe5e5; --accent-text: #FFFFFF;
    --danger: #C74A4A; --danger-hover: #B03E3E; --danger-subtle: #FCEAEA;
    --success: #3A8F6E; --success-subtle: #E6F5EE; --warning: #C4890C; --warning-subtle: #FFF5E0;
    --code-bg: #D4D4D4; --tab-active: #FFFFFF; --tab-hover: #D4D4D4; --overlay: rgba(0,0,0,0.3);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 16px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
  }
  [data-theme="dark"] {
    --bg-base: #000000; --bg-surface: #111111; --bg-surface-hover: #1A1A1A; --bg-inset: #0A0A0A;
    --bg-chat-user: #1A1A1A; --bg-chat-assistant: transparent; --border: #333333; --border-subtle: #1A1A1A;
    --text-primary: #E8E5E0; --text-secondary: #9C9790; --text-tertiary: #6B6762;
    --accent: #e63946; --accent-hover: #d62828; --accent-subtle: #2a0f0f; --accent-text: #111110;
    --danger: #E06B6B; --danger-hover: #E88080; --danger-subtle: #2D1A1A;
    --success: #5CC99A; --success-subtle: #1A2D22; --warning: #E0A830; --warning-subtle: #2D2510;
    --code-bg: #1A1A1A; --tab-active: #1A1A1A; --tab-hover: #252525; --overlay: rgba(0,0,0,0.6);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2); --shadow-md: 0 4px 16px rgba(0,0,0,0.3); --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
  }
  html { height: 100%; }
  body { font-family: var(--font-body); background: var(--bg-base); color: var(--text-primary); height: 100%; overflow: hidden; transition: background var(--transition), color var(--transition); }
  .app { display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; }
  .header { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand-icon { width: 34px; height: 34px; background: var(--accent); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 17px; color: var(--accent-text); font-weight: 600; box-shadow: var(--shadow-sm); }
  .brand-text h1 { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; line-height: 1.2; }
  .brand-text span { font-size: 11px; color: var(--text-tertiary); }
  .header-actions { display: flex; align-items: center; gap: 8px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-tertiary); transition: background var(--transition); }
  .status-dot.ok { background: var(--success); } .status-dot.err { background: var(--danger); }
  .status-label { font-size: 12px; color: var(--text-tertiary); margin-right: 8px; }
  .btn-icon { width: 34px; height: 34px; border: 1px solid var(--border); background: var(--bg-surface); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition); color: var(--text-secondary); }
  .btn-icon:hover { background: var(--bg-surface-hover); border-color: var(--text-tertiary); }
  .btn-icon svg { width: 17px; height: 17px; }
  .tabs-bar { display: flex; align-items: center; gap: 2px; padding: 8px 24px 0; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; overflow-x: auto; scrollbar-width: none; }
  .tabs-bar::-webkit-scrollbar { display: none; }
  .tab { display: flex; align-items: center; gap: 6px; padding: 8px 14px; font-family: var(--font-body); font-size: 12.5px; font-weight: 500; color: var(--text-tertiary); background: transparent; border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; white-space: nowrap; transition: all var(--transition); max-width: 180px; }
  .tab:hover { color: var(--text-secondary); background: var(--tab-hover); }
  .tab.active { color: var(--text-primary); background: var(--tab-active); border-color: var(--border-subtle); box-shadow: var(--shadow-sm); }
  .tab-label { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
  .tab-close { width: 16px; height: 16px; border: none; background: transparent; color: var(--text-tertiary); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; flex-shrink: 0; transition: all var(--transition); }
  .tab-close:hover { background: var(--danger-subtle); color: var(--danger); }
  .tab-new { padding: 8px 10px; font-family: var(--font-body); font-size: 16px; color: var(--text-tertiary); background: transparent; border: 1px dashed var(--border); border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; transition: all var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; width: 34px; }
  .tab-new:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-subtle); }
  .chat-area { flex: 1; overflow-y: auto; padding: 24px; scroll-behavior: smooth; }
  .chat-area::-webkit-scrollbar { width: 6px; } .chat-area::-webkit-scrollbar-track { background: transparent; } .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 16px; opacity: 0.8; }
  .welcome-icon { width: 64px; height: 64px; background: var(--accent-subtle); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: var(--accent); }
  .welcome h2 { font-size: 22px; font-weight: 600; letter-spacing: -0.5px; }
  .welcome p { font-size: 14px; color: var(--text-secondary); text-align: center; max-width: 400px; line-height: 1.6; }
  .message { margin-bottom: 20px; animation: msgIn 0.3s ease-out; } .message.no-anim { animation: none; }
  @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .message-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-tertiary); margin-bottom: 6px; padding-left: 2px; }
  .message-label.assistant-label { color: var(--accent); }
  .message-body { padding: 14px 18px; border-radius: var(--radius); font-size: 14.5px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
  .message-body.user-body { background: var(--bg-chat-user); border: 1px solid var(--border-subtle); }
  .message-body.assistant-body { background: var(--bg-chat-assistant); }
  .message-body code { font-family: var(--font-mono); font-size: 13px; background: var(--code-bg); padding: 2px 6px; border-radius: 4px; }
  .message-body pre { background: var(--code-bg); padding: 12px 16px; border-radius: var(--radius-sm); overflow-x: auto; margin: 8px 0; border: 1px solid var(--border-subtle); }
  .message-body pre code { background: none; padding: 0; }
  .action-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); margin: 12px 0; overflow: hidden; box-shadow: var(--shadow-sm); animation: msgIn 0.3s ease-out; }
  .action-card.no-anim { animation: none; }
  .action-header { display: flex; align-items: flex-start; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-inset); }
  .action-type-badge { font-family: var(--font-mono); font-size: 11px; font-weight: 500; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .action-type-badge.read { background: var(--accent-subtle); color: var(--accent); }
  .action-type-badge.cmd { background: var(--warning-subtle); color: var(--warning); }
  .action-type-badge.script { background: var(--warning-subtle); color: var(--warning); }
  .action-type-badge.write { background: var(--danger-subtle); color: var(--danger); }
  .action-target { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); white-space: pre-wrap; word-break: break-all; flex: 1; }
  .action-copy-btn { background: none; border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-tertiary); cursor: pointer; padding: 3px 5px; line-height: 1; flex-shrink: 0; transition: all var(--transition); } .action-copy-btn:hover { color: var(--text-primary); border-color: var(--text-secondary); } .action-copy-btn svg { width: 14px; height: 14px; display: block; } .action-copy-btn.copied { color: var(--success); border-color: var(--success); }
  .action-body { padding: 12px 16px; }
  .action-content-preview { font-family: var(--font-mono); font-size: 12px; background: var(--code-bg); padding: 10px 12px; border-radius: var(--radius-sm); margin-bottom: 12px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; color: var(--text-secondary); border: 1px solid var(--border-subtle); }
  .action-buttons { display: flex; gap: 8px; }
  .btn { font-family: var(--font-body); font-size: 13px; font-weight: 500; padding: 8px 20px; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all var(--transition); display: inline-flex; align-items: center; gap: 6px; }
  .btn-approve { background: var(--accent); color: var(--accent-text); } .btn-approve:hover { background: var(--accent-hover); }
  .btn-deny { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); } .btn-deny:hover { background: var(--danger-subtle); color: var(--danger); border-color: var(--danger); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .action-result { margin-top: 10px; padding: 10px 12px; border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; line-height: 1.5; }
  .action-result.success { background: var(--success-subtle); color: var(--success); border: 1px solid var(--success); }
  .action-result.failure { background: var(--danger-subtle); color: var(--danger); border: 1px solid var(--danger); }
  .action-result.denied { background: var(--bg-inset); color: var(--text-tertiary); border: 1px solid var(--border); }
  .streaming-dot { display: inline-block; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; margin-left: 4px; animation: blink 1s ease-in-out infinite; vertical-align: middle; }
  @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
  .input-area { padding: 16px 24px 24px; border-top: 1px solid var(--border-subtle); flex-shrink: 0; }
  .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
  .input-field { flex: 1; font-family: var(--font-body); font-size: 14.5px; padding: 12px 16px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); resize: none; min-height: 46px; max-height: 160px; line-height: 1.5; transition: border var(--transition), box-shadow var(--transition); outline: none; }
  .input-field::placeholder { color: var(--text-tertiary); }
  .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-subtle); }
  .btn-send { width: 46px; height: 46px; background: var(--accent); color: var(--accent-text); border: none; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition); flex-shrink: 0; }
  .btn-send:hover { background: var(--accent-hover); transform: scale(1.04); }
  .btn-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-send svg { width: 20px; height: 20px; }
  .input-hint { font-size: 11px; color: var(--text-tertiary); margin-top: 8px; text-align: center; }

  /* ── Settings ── */
  .settings-overlay { position: fixed; inset: 0; background: var(--overlay); z-index: 100; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
  .settings-overlay.open { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .settings-panel { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 540px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); animation: slideUp 0.25s ease-out; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  .settings-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
  .settings-header h2 { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
  .settings-close { width: 32px; height: 32px; border: none; background: transparent; color: var(--text-tertiary); cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all var(--transition); }
  .settings-close:hover { background: var(--bg-inset); color: var(--text-primary); }
  .settings-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
  .field { margin-bottom: 20px; }
  .field-label { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px; display: block; }
  .field-hint { font-size: 11.5px; color: var(--text-tertiary); margin-bottom: 8px; line-height: 1.4; }
  .field-input { width: 100%; font-family: var(--font-mono); font-size: 13px; padding: 10px 14px; background: var(--bg-inset); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); outline: none; transition: border var(--transition); }
  .field-input:focus { border-color: var(--accent); }
  .path-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
  .path-row { display: flex; gap: 6px; align-items: center; }
  .path-row .field-input { flex: 1; margin: 0; }
  .path-remove { width: 32px; height: 32px; border: 1px solid var(--border); background: transparent; color: var(--text-tertiary); cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all var(--transition); flex-shrink: 0; }
  .path-remove:hover { background: var(--danger-subtle); color: var(--danger); border-color: var(--danger); }
  .path-add { font-family: var(--font-body); font-size: 12px; font-weight: 500; padding: 6px 14px; background: transparent; border: 1px dashed var(--border); border-radius: var(--radius-sm); color: var(--text-tertiary); cursor: pointer; transition: all var(--transition); display: inline-flex; }
  .path-add:hover { color: var(--accent); border-color: var(--accent); }
  .settings-footer { padding: 16px 24px 20px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-shrink: 0; }
  .save-msg { font-size: 12px; color: var(--success); flex: 1; } .save-msg.err { color: var(--danger); }
  .btn-save { font-family: var(--font-body); font-size: 13px; font-weight: 500; padding: 10px 24px; background: var(--accent); color: var(--accent-text); border: none; border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition); white-space: nowrap; }
  .btn-save:hover { background: var(--accent-hover); }

  /* ── Stop button ── */
  .btn-send.stopping { background: var(--danger); }
  .btn-send.stopping:hover { background: var(--danger-hover); }

  /* ── Edit message ── */
  .message-user-wrap { position: relative; }
  .message-edit-btn {
    position: absolute; right: 8px; top: 28px; width: 28px; height: 28px;
    border: 1px solid var(--border); background: var(--bg-surface); border-radius: var(--radius-sm);
    display: none; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-tertiary); transition: all var(--transition); z-index: 2;
  }
  .message-user-wrap:hover .message-edit-btn { display: flex; }
  .message-edit-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-subtle); }
  .message-edit-btn svg { width: 14px; height: 14px; }
  .edit-container { margin-top: 8px; }
  .edit-textarea {
    width: 100%; font-family: var(--font-body); font-size: 14.5px; padding: 12px 16px;
    background: var(--bg-surface); border: 2px solid var(--accent); border-radius: var(--radius);
    color: var(--text-primary); resize: vertical; min-height: 60px; max-height: 200px;
    line-height: 1.5; outline: none; transition: border var(--transition);
  }
  .edit-actions { display: flex; gap: 8px; margin-top: 8px; justify-content: flex-end; }
  .edit-actions .btn { padding: 6px 16px; font-size: 12.5px; }
  .branch-notice { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; font-style: italic; }

  /* ── Settings Tabs ── */
  .settings-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border-subtle); margin-bottom: 16px; }
  .settings-tab { padding: 10px 20px; font-family: var(--font-body); font-size: 13px; font-weight: 500; color: var(--text-tertiary); background: transparent; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: all var(--transition); }
  .settings-tab:hover { color: var(--text-secondary); }
  .settings-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .settings-tab-content { display: none; }
  .settings-tab-content.active { display: block; }

  /* ── Toggle Switch ── */
  .toggle-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; }
  .toggle-label-group { display: flex; flex-direction: column; gap: 2px; flex: 1; }
  .toggle-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-slider { position: absolute; inset: 0; background: var(--border); border-radius: 12px; cursor: pointer; transition: all var(--transition); }
  .toggle-slider::before { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: all var(--transition); }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

  /* ── Audio / Mic Button ── */
  .btn-audio { width: 46px; height: 46px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; display: none; align-items: center; justify-content: center; transition: all var(--transition); flex-shrink: 0; }
  .btn-audio.visible { display: flex; }
  .btn-audio:hover { background: var(--bg-surface-hover); border-color: var(--text-tertiary); }
  .btn-audio.recording { background: var(--danger-subtle); border-color: var(--danger); color: var(--danger); }
  .btn-audio.recording:hover { background: var(--danger-subtle); border-color: var(--danger-hover); }
  .btn-audio svg { width: 20px; height: 20px; }
  @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(199,74,74,0.4); } 70% { box-shadow: 0 0 0 8px rgba(199,74,74,0); } 100% { box-shadow: 0 0 0 0 rgba(199,74,74,0); } }
  .btn-audio.recording { animation: pulse-ring 1.5s ease-in-out infinite; }

  /* ── TTS Speaking Indicator ── */
  .tts-indicator { display: none; align-items: center; gap: 6px; font-size: 11px; color: var(--accent); padding: 4px 0; }
  .tts-indicator.active { display: flex; }
  .tts-bars { display: flex; gap: 2px; align-items: flex-end; height: 14px; }
  .tts-bar { width: 3px; background: var(--accent); border-radius: 1px; animation: tts-eq 0.8s ease-in-out infinite; }
  .tts-bar:nth-child(1) { height: 6px; animation-delay: 0s; }
  .tts-bar:nth-child(2) { height: 10px; animation-delay: 0.15s; }
  .tts-bar:nth-child(3) { height: 4px; animation-delay: 0.3s; }
  .tts-bar:nth-child(4) { height: 12px; animation-delay: 0.45s; }
  @keyframes tts-eq { 0%, 100% { transform: scaleY(0.4); } 50% { transform: scaleY(1); } }
  .tts-stop { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 11px; font-family: var(--font-body); text-decoration: underline; padding: 0; transition: color var(--transition); }
  .tts-stop:hover { color: var(--danger); }

  /* ── Per-message Audio Controls ── */
  .msg-audio-bar { display: none; align-items: center; gap: 2px; margin-top: 6px; padding: 2px 0; }
  .msg-audio-bar.visible { display: flex; }
  .msg-audio-btn { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 11px; font-family: var(--font-body); display: flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; transition: all var(--transition); }
  .msg-audio-btn:hover { color: var(--accent); background: var(--accent-subtle); }
  .msg-audio-btn svg { width: 13px; height: 13px; }
  .msg-audio-btn.stop-btn:hover { color: var(--danger); background: var(--danger-subtle); }

  /* ── Developer CTA Banner ── */
  @keyframes ctaPulse { from { border-color: var(--accent); } to { border-color: var(--border); } }

  @media (max-width: 640px) {
    .header { padding: 12px 16px; } .tabs-bar { padding: 8px 16px 0; } .chat-area { padding: 16px; } .input-area { padding: 12px 16px 20px; }
    .brand-text span { display: none; } .tab { max-width: 130px; padding: 7px 10px; }
    .settings-panel { width: 95%; max-height: 90vh; }
  }
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="brand">
      <div class="brand-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div>
      <div class="brand-text"><h1>MiddleClaw</h1><span>System Diagnostics</span></div>
    </div>
    <div class="header-actions">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-label" id="statusLabel">Checking…</span>
      <button class="btn-icon" id="settingsBtn" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
      <button class="btn-icon" id="themeToggle" title="Toggle theme">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </header>
  <div class="tabs-bar" id="tabsBar"><button class="tab-new" id="newTabBtn" title="New session">+</button></div>
  <div class="chat-area" id="chatArea"></div>
  <div class="input-area">
    <div class="input-wrapper">
      <textarea class="input-field" id="input" placeholder="Describe the issue…" rows="1"></textarea>
      <button class="btn-audio" id="audioBtn" title="Voice input">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      </button>
      <button class="btn-send" id="sendBtn" title="Send">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">Actions require your explicit approval before execution</div>
    <div class="tts-indicator" id="ttsIndicator">
      <div class="tts-bars"><div class="tts-bar"></div><div class="tts-bar"></div><div class="tts-bar"></div><div class="tts-bar"></div></div>
      <span>Speaking…</span>
      <button class="tts-stop" id="ttsStopBtn">Stop</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-panel">
    <div class="settings-header"><h2>Settings</h2><button class="settings-close" id="settingsClose">×</button></div>
    <div class="settings-body">
      <div class="settings-tabs">
        <button class="settings-tab active" data-settings-tab="general">General</button>
        <button class="settings-tab" data-settings-tab="experimental">Experimental</button>
      </div>
      <div class="settings-tab-content active" id="settingsGeneral">
        <div class="field">
          <label class="field-label">Ollama URL</label>
          <input class="field-input" id="cfgOllamaUrl" type="text" placeholder="http://localhost:11434">
        </div>
        <div class="field">
          <label class="field-label">Model</label>
          <input class="field-input" id="cfgModel" type="text" placeholder="glm-4.7:cloud">
        </div>
        <div class="field">
          <label class="field-label">Port</label>
          <div class="field-hint">Requires restart to take effect.</div>
          <input class="field-input" id="cfgPort" type="number" placeholder="3333">
        </div>
        <div class="field">
          <label class="field-label">OpenClaw Directory</label>
          <div class="field-hint">Main directory of your OpenClaw installation. Automatically included in read and write paths.</div>
          <input class="field-input" id="cfgOpenclawDir" type="text" placeholder="/opt/openclaw">
        </div>
        <div class="field">
          <label class="field-label">OpenClaw Workspace</label>
          <div class="field-hint">Directory where OpenClaw writes files (workspace/*.md, memory/, etc.). Automatically included in read and write paths.</div>
          <input class="field-input" id="cfgOpenclawWorkspaceDir" type="text" placeholder="/home/user/.openclaw/workspace">
        </div>
        <div class="field">
          <label class="field-label">Operating System</label>
          <div class="field-hint">Tells MiddleClaw which commands and shell syntax to use.</div>
          <select class="field-input" id="cfgOs">
            <option value="linux">Linux</option>
            <option value="macos">macOS</option>
            <option value="windows">Windows</option>
          </select>
        </div>
        <div class="field">
          <label class="field-label">Readable Paths</label>
          <div class="field-hint">Directories MiddleClaw is allowed to read from. Changes take effect immediately.</div>
          <div class="path-list" id="readPathsList"></div>
          <button class="path-add" id="addReadPath">+ Add path</button>
        </div>
        <div class="field">
          <label class="field-label">Writable Paths</label>
          <div class="field-hint">Directories MiddleClaw is allowed to write to. Changes take effect immediately.</div>
          <div class="path-list" id="writePathsList"></div>
          <button class="path-add" id="addWritePath">+ Add path</button>
        </div>
      </div>
      <div class="settings-tab-content" id="settingsExperimental">
        <div class="field">
          <div class="toggle-row">
            <div class="toggle-label-group">
              <label class="field-label" style="margin-bottom:0">Enable Audio Conversing</label>
              <div class="field-hint" style="margin-bottom:0">Talk to MiddleClaw using your microphone and hear responses spoken aloud via ElevenLabs.</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="cfgAudioEnabled">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="field">
          <label class="field-label">ElevenLabs API Key</label>
          <div class="field-hint">Required for text-to-speech. Get your key at <a href="https://elevenlabs.io" target="_blank" style="color:var(--accent)">elevenlabs.io</a>.</div>
          <input class="field-input" id="cfgElevenlabsKey" type="password" placeholder="xi-xxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        </div>
        <div class="field">
          <label class="field-label">ElevenLabs Voice ID</label>
          <div class="field-hint">The voice to use for speech. Leave blank for the default voice (Rachel).</div>
          <input class="field-input" id="cfgElevenlabsVoice" type="text" placeholder="21m00Tcm4TlvDq8ikWAM">
        </div>
      </div>
    </div>
    <div class="settings-footer">
      <div class="save-msg" id="saveMsg"></div>
      <button class="btn-save" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  const SK='doctorclaw-sessions', AK='doctorclaw-active-session', AUDIO_KEY='doctorclaw-audio-enabled';
  function loadS(){try{return JSON.parse(localStorage.getItem(SK))||[];}catch{return[];}}
  function saveS(s){localStorage.setItem(SK,JSON.stringify(s));}
  function gAI(){return localStorage.getItem(AK);}
  function sAI(id){localStorage.setItem(AK,id);}
  let sessions=loadS(),activeId=gAI(),streaming=false,abortController=null;
  let audioEnabled=localStorage.getItem(AUDIO_KEY)==='true';
  const SEND_ICON='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
  const STOP_ICON='<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
  if(!sessions.length){const s=mkS();sessions.push(s);activeId=s.id;persist();}
  else if(!sessions.find(s=>s.id===activeId)){activeId=sessions[0].id;persist();}
  function mkS(){const n=new Date();return{id:'s_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),label:n.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}),conversation:[],rendered:[],createdAt:n.toISOString()};}
  function cur(){return sessions.find(s=>s.id===activeId);}
  function findLiveAct(id){for(const s of sessions){for(const e of s.rendered){if(e.actions){for(const a of e.actions){if(a.id===id)return a;}}}}return null;}

  function persist(){
    saveS(sessions);
    sAI(activeId);
  }

  // Cross-tab sync: when another tab writes to localStorage, reload
  window.addEventListener('storage',e=>{
    if(e.key===SK&&!streaming){
      const fresh=loadS();
      // Preserve our active session's in-memory state if we're mid-conversation
      const currentActive=cur();
      sessions=fresh;
      if(currentActive){
        const idx=sessions.findIndex(s=>s.id===currentActive.id);
        if(idx>-1)sessions[idx]=currentActive;
      }
      renderTabs();renderChat();
    }
  });

  const chatArea=document.getElementById('chatArea'),input=document.getElementById('input'),sendBtn=document.getElementById('sendBtn'),
    tabsBar=document.getElementById('tabsBar'),newTabBtn=document.getElementById('newTabBtn'),themeToggle=document.getElementById('themeToggle'),
    statusDot=document.getElementById('statusDot'),statusLabel=document.getElementById('statusLabel'),
    audioBtn=document.getElementById('audioBtn'),ttsIndicator=document.getElementById('ttsIndicator'),ttsStopBtn=document.getElementById('ttsStopBtn');

  // Theme
  const st=localStorage.getItem('dc-theme')||'light';document.documentElement.setAttribute('data-theme',st);updTI();
  themeToggle.addEventListener('click',()=>{const nx=document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',nx);localStorage.setItem('dc-theme',nx);updTI();});
  function updTI(){const d=document.documentElement.getAttribute('data-theme')==='dark';document.getElementById('themeIcon').innerHTML=d?'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>':'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';}

  // Health
  async function chk(){try{const r=await fetch('/api/health');const d=await r.json();statusDot.className=d.status==='ok'?'status-dot ok':'status-dot err';statusLabel.textContent=d.status==='ok'?'Connected':'Offline';}catch{statusDot.className='status-dot err';statusLabel.textContent='Offline';}}
  chk();setInterval(chk,15000);

  // SSE: Async action completion events
  let eventSource=null;
  function connectEvents(){
    if(eventSource)return;
    eventSource=new EventSource('/api/events?'+Date.now());
    eventSource.addEventListener('action-complete',async(e)=>{
      try{
        const data=JSON.parse(e.data);
        const act=findLiveAct(data.actionId);
        if(!act)return;
        act.status=data.success?'approved':'denied';
        act.result=data.result;
        act.resultSuccess=data.success;
        persist();
        const card=findCardByActionId(data.actionId);
        if(card){
          const rc=card.querySelector('.action-result-container');
          rc.innerHTML='<div class="action-result '+(data.success?'success':'failure')+'">'+esc(data.result)+'</div>';
          const ab=card.querySelector('[data-action="approve"]');const db=card.querySelector('[data-action="deny"]');
          if(ab){ab.disabled=true;ab.textContent=data.success?'✓ Completed':'✕ Failed';}
          if(db){db.disabled=true;}
          scrollDown();
        }
        const MAX_RESULT=4000;
        let resultForConv=data.result;
        if(resultForConv.length>MAX_RESULT)resultForConv=resultForConv.slice(0,MAX_RESULT)+'\n…[truncated — '+data.result.length+' total characters]';
        cur().conversation.push({role:'user',content:'[Result of '+act.type+' on "'+act.target+'"]: '+(data.success?'SUCCESS':'FAILED')+'\n'+resultForConv});
        persist();
      }catch(err){console.error('SSE error:',err);}
    });
    eventSource.onerror=(e)=>{console.warn('[SSE] Connection error:',e);};
  }
  function findCardByActionId(actionId){
    const cards=chatArea.querySelectorAll('.action-card');
    const s=cur();
    if(!s)return null;
    const cardActions=s.rendered.flatMap(e=>e.actions||[]);
    for(const card of cards){
      const approveBtn=card.querySelector('[data-action="approve"]');
      for(const a of cardActions){
        if(a.actionId===actionId||a.id===actionId){
          return card;
        }
      }
    }
    return null;
  }
  connectEvents();

  // Settings
  const sOverlay=document.getElementById('settingsOverlay'),sBtn=document.getElementById('settingsBtn'),sClose=document.getElementById('settingsClose'),saveBtn=document.getElementById('saveSettings'),saveMsg=document.getElementById('saveMsg');
  sBtn.addEventListener('click',openSettings);sClose.addEventListener('click',()=>sOverlay.classList.remove('open'));
  sOverlay.addEventListener('click',e=>{if(e.target===sOverlay)sOverlay.classList.remove('open');});

  // Settings tabs
  document.querySelectorAll('.settings-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.settings-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.settings-tab-content').forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      const target=tab.getAttribute('data-settings-tab');
      document.getElementById(target==='general'?'settingsGeneral':'settingsExperimental').classList.add('active');
    });
  });

  async function openSettings(){
    saveMsg.textContent='';
    // Reset to General tab
    document.querySelectorAll('.settings-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.settings-tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelector('[data-settings-tab="general"]').classList.add('active');
    document.getElementById('settingsGeneral').classList.add('active');
    try{
      const r=await fetch('/api/config');const cfg=await r.json();
      document.getElementById('cfgOllamaUrl').value=cfg.ollama_url||'';
      document.getElementById('cfgModel').value=cfg.model||'';
      document.getElementById('cfgPort').value=cfg.port||'';
      document.getElementById('cfgOpenclawDir').value=cfg.openclaw_dir||'';
      document.getElementById('cfgOpenclawWorkspaceDir').value=cfg.openclaw_workspace_dir||'';
      document.getElementById('cfgOs').value=cfg.os||'linux';
      renderPL('readPathsList',cfg.read_paths||[]);
      renderPL('writePathsList',cfg.write_paths||[]);
      // Experimental fields
      document.getElementById('cfgAudioEnabled').checked=!!cfg.audio_enabled;
      document.getElementById('cfgElevenlabsKey').value=cfg.elevenlabs_api_key||'';
      document.getElementById('cfgElevenlabsVoice').value=cfg.elevenlabs_voice_id||'';
    }catch{saveMsg.textContent='Could not load config.';saveMsg.className='save-msg err';}
    sOverlay.classList.add('open');
  }

  function renderPL(id,paths){
    const c=document.getElementById(id);c.innerHTML='';
    paths.forEach(p=>{addPathRow(c,p);});
  }
  function addPathRow(container,value){
    const row=document.createElement('div');row.className='path-row';
    const inp=document.createElement('input');inp.className='field-input';inp.type='text';inp.value=value||'';inp.placeholder='/path/to/directory';
    const rm=document.createElement('button');rm.className='path-remove';rm.textContent='×';rm.title='Remove';
    rm.addEventListener('click',()=>row.remove());
    row.appendChild(inp);row.appendChild(rm);container.appendChild(row);
    if(!value)inp.focus();
  }
  document.getElementById('addReadPath').addEventListener('click',()=>addPathRow(document.getElementById('readPathsList'),''));
  document.getElementById('addWritePath').addEventListener('click',()=>addPathRow(document.getElementById('writePathsList'),''));

  function gatherPaths(id){return Array.from(document.querySelectorAll('#'+id+' .field-input')).map(i=>i.value.trim()).filter(Boolean);}

  saveBtn.addEventListener('click',async()=>{
    saveMsg.textContent='Saving…';saveMsg.className='save-msg';
    try{
      const body={
        ollama_url:document.getElementById('cfgOllamaUrl').value.trim(),
        model:document.getElementById('cfgModel').value.trim(),
        port:document.getElementById('cfgPort').value.trim(),
        openclaw_dir:document.getElementById('cfgOpenclawDir').value.trim(),
        openclaw_workspace_dir:document.getElementById('cfgOpenclawWorkspaceDir').value.trim(),
        os:document.getElementById('cfgOs').value,
        read_paths:gatherPaths('readPathsList'),
        write_paths:gatherPaths('writePathsList'),
        audio_enabled:document.getElementById('cfgAudioEnabled').checked,
        elevenlabs_api_key:document.getElementById('cfgElevenlabsKey').value.trim(),
        elevenlabs_voice_id:document.getElementById('cfgElevenlabsVoice').value.trim(),
      };
      const r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const d=await r.json();saveMsg.textContent=d.message;saveMsg.className=d.success?'save-msg':'save-msg err';
      // Update audio state
      audioEnabled=body.audio_enabled;
      localStorage.setItem(AUDIO_KEY,audioEnabled?'true':'false');
      updateAudioBtnVisibility();
    }catch(e){saveMsg.textContent='Save failed: '+e.message;saveMsg.className='save-msg err';}
  });

  // Tabs
  function renderTabs(){
    tabsBar.querySelectorAll('.tab').forEach(t=>t.remove());
    sessions.forEach(s=>{
      const tab=document.createElement('div');tab.className='tab'+(s.id===activeId?' active':'');
      const lbl=document.createElement('span');lbl.className='tab-label';lbl.textContent=s.label;lbl.title=s.label;tab.appendChild(lbl);
      const cl=document.createElement('button');cl.className='tab-close';cl.textContent='×';cl.addEventListener('click',e=>{e.stopPropagation();closeS(s.id);});tab.appendChild(cl);
      tab.addEventListener('click',()=>switchS(s.id));tabsBar.insertBefore(tab,newTabBtn);
    });
  }
  function switchS(id){if(streaming||id===activeId)return;activeId=id;persist();renderTabs();renderChat();input.focus();}
  function closeS(id){if(streaming)return;sessions=sessions.filter(s=>s.id!==id);if(!sessions.length)sessions.push(mkS());if(activeId===id)activeId=sessions[sessions.length-1].id;persist();renderTabs();renderChat();}
  newTabBtn.addEventListener('click',()=>{if(streaming)return;const s=mkS();sessions.push(s);activeId=s.id;persist();renderTabs();renderChat();input.focus();});

  // Chat
  function renderChat(){
    chatArea.innerHTML='';const s=cur();
    if(!s||!s.rendered.length){chatArea.innerHTML='<div class="welcome"><div class="welcome-icon"><svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div><h2>Hi! I\'m your OpenClaw Bridge</h2><p>Tell me what you need. I\'ll interact with OpenClaw, asking for permission before reading files, running commands, or making changes.</p></div>';return;}
    s.rendered.forEach((e,idx)=>{
      const w=document.createElement('div');w.className='message no-anim';
      if(e.role==='user')w.classList.add('message-user-wrap');
      const l=document.createElement('div');l.className='message-label'+(e.role==='assistant'?' assistant-label':'');l.textContent=e.role==='user'?'You':'OpenClaw';
      const b=document.createElement('div');b.className='message-body '+e.role+'-body';
      b.innerHTML=fmt((e.content||'').replace(ACT_RE_STRIP,'').replace(ACT_RE_STRIP_OLD,'').replace(ACT_RE_PARTIAL,'').trim());
      w.appendChild(l);w.appendChild(b);
      if(e.role==='user'&&!streaming){
        const eb=document.createElement('button');eb.className='message-edit-btn';eb.title='Edit message';
        eb.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
        eb.addEventListener('click',()=>startEdit(idx,e.content,w,b));
        w.appendChild(eb);
      }
      chatArea.appendChild(w);
      if(e.role==='assistant'&&audioEnabled){w.appendChild(createAudioBar(e.content));}
      if(e.actions)e.actions.forEach(a=>restoreAct(a,w));
    });scrollDown();
  }

  function restoreAct(act,after){
    act.target=(act.target||'').replace(/\[\/ACTION\s*$/,'').trimEnd();
    if(act.content)act.content=act.content.replace(/\[\/ACTION\s*$/,'').trimEnd();
    const card=document.createElement('div');card.className='action-card no-anim';
    const bc=actBadge(act.type);
    const tl=actLabel(act.type);
    let h='<div class="action-header"><span class="action-type-badge '+bc+'">'+tl+'</span><span class="action-target" title="'+esc(act.target)+'">'+esc(act.target)+'</span><button class="action-copy-btn" data-copy="'+esc(act.target)+'" title="Copy"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button></div><div class="action-body">';
    if(act.content)h+='<div class="action-content-preview">'+esc(act.content)+'</div>';
    if(act.status==='pending')h+='<div class="action-buttons"><button class="btn btn-approve" data-action="approve">✓ Approve</button><button class="btn btn-deny" data-action="deny">✕ Deny</button></div>';
    else if(act.status==='approved')h+='<div class="action-buttons"><button class="btn btn-approve" disabled>✓ Approved</button></div>';
    else if(act.status==='running')h+='<div class="action-buttons"><button class="btn btn-approve" disabled>Running…</button></div>';
    else h+='<div class="action-buttons"><button class="btn btn-deny" disabled>✕ Denied</button></div>';
    h+='<div class="action-result-container">';
    if(act.result){const c=act.status==='denied'?'denied':(act.resultSuccess?'success':'failure');h+='<div class="action-result '+c+'">'+esc(act.result)+'</div>';}
    h+='</div></div>';card.innerHTML=h;after.after(card);
    if(act.status==='pending')wireAct(card,act);
  }

  function wireAct(card,act){
    const ab=card.querySelector('[data-action="approve"]'),db=card.querySelector('[data-action="deny"]'),rc=card.querySelector('.action-result-container');
    ab.addEventListener('click',async()=>{
      ab.disabled=true;db.disabled=true;ab.textContent='Starting…';
      try{
        const res=await fetch('/api/execute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:act.type,target:act.target,content:act.content})});
        const data=await res.json();
        if(data.status==='running'){
          const currentAct=findLiveAct(act.id);
          currentAct.status='running';
          currentAct.actionId=data.actionId;
          persist();
          ab.textContent='Running in background…';
          db.style.display='none';
          const info=document.createElement('div');
          info.className='action-info';
          info.textContent='Running asynchronously. You can continue chatting. Result will appear when complete.';
          info.style.cssText='font-size:12px;color:var(--text-tertiary);margin:8px 0;padding:8px;background:var(--bg-inset);border-radius:4px;';
          rc.appendChild(info);
          return;
        }
        const currentAct=findLiveAct(act.id);currentAct.status='approved';currentAct.result=data.result;currentAct.resultSuccess=data.success;persist();
        const r=document.createElement('div');r.className='action-result '+(data.success?'success':'failure');r.textContent=data.result;rc.appendChild(r);ab.textContent='✓ Approved';
        let resultForConv=data.result;const MAX_RESULT=4000;
        if(resultForConv.length>MAX_RESULT)resultForConv=resultForConv.slice(0,MAX_RESULT)+'\n…[truncated — '+data.result.length+' total characters]';
        cur().conversation.push({role:'user',content:'[Result of '+currentAct.type+' on "'+currentAct.target+'"]: '+(data.success?'SUCCESS':'FAILED')+'\n'+resultForConv});persist();
        streaming=true;setSendBtnStreaming(true);try{await streamResp();}finally{streaming=false;setSendBtnStreaming(false);}
      }catch(err){const errAct=findLiveAct(act.id);if(errAct)errAct.status='pending';persist();const r=document.createElement('div');r.className='action-result failure';r.textContent='Error: '+err.message;rc.appendChild(r);ab.textContent='✓ Approve';ab.disabled=false;db.disabled=false;}
      scrollDown();
    });
    db.addEventListener('click',()=>{
      ab.disabled=true;db.disabled=true;ab.textContent='✕ Denied';act.status='denied';act.result='Action denied by user.';persist();
      const r=document.createElement('div');r.className='action-result denied';r.textContent='Action denied by user.';rc.appendChild(r);
      cur().conversation.push({role:'user',content:'[User DENIED the action: '+act.type+' on "'+act.target+'"]'});persist();scrollDown();
    });
  }

  function fmt(t){let h=esc(t);h=h.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>');h=h.replace(/`([^`]+)`/g,'<code>$1</code>');h=h.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');return h;}
  function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
  function scrollDown(){requestAnimationFrame(()=>{chatArea.scrollTop=chatArea.scrollHeight;});}
  function actBadge(t){return t==='READ_FILE'?'read':t==='RUN_CMD'?'cmd':t==='RUN_SCRIPT'?'script':'write';}
  function actLabel(t){return t==='READ_FILE'?'Read File':t==='RUN_CMD'?'Run Command':t==='RUN_SCRIPT'?'Run Script':'Write File';}
  const ACT_TYPES='READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE';
  const ACT_RE_STRIP=new RegExp('\\[ACTION:('+ACT_TYPES+'):[\\s\\S]+?\\[/ACTION\\]','g');
  const ACT_RE_STRIP_OLD=new RegExp('\\[ACTION:('+ACT_TYPES+'):[^\\]]*\\]','g');
  const ACT_RE_PARTIAL=/\[ACTION[\s\S]*$/;

  chatArea.addEventListener('click',e=>{const btn=e.target.closest('.action-copy-btn');if(!btn)return;const text=btn.getAttribute('data-copy');navigator.clipboard.writeText(text).then(()=>{btn.classList.add('copied');btn.title='Copied!';setTimeout(()=>{btn.classList.remove('copied');btn.title='Copy';},1500);});});

  input.addEventListener('input',()=>{input.style.height='auto';input.style.height=Math.min(input.scrollHeight,160)+'px';});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
  sendBtn.addEventListener('click',()=>{if(streaming){if(abortController)abortController.abort();}else{sendMsg();}});

  async function sendMsg(){
    if(streaming) return;
    const text=input.value.trim();
    // If recording with no text yet, queue auto-send and stop recording
    if(!text&&isRecording){sttAutoSend=true;input.value='';input.placeholder='Transcribing & sending…';input.disabled=true;stopRecording();return;}
    if(!text) return;
    const s=cur();
    // If recording with text already, stop and send immediately
    if(isRecording){sttSkipOnStop=true;stopRecording();}
    if(!s.conversation.length){s.label=text.length>30?text.slice(0,30)+'…':text;renderTabs();}
    s.conversation.push({role:'user',content:text});s.rendered.push({role:'user',content:text});persist();
    input.value='';input.style.height='auto';renderChat();
    streaming=true;setSendBtnStreaming(true);try{await streamResp();}finally{streaming=false;setSendBtnStreaming(false);}input.focus();
  }

  async function streamResp(){
    const s=cur();abortController=new AbortController();
    const w=document.createElement('div');w.className='message';
    const l=document.createElement('div');l.className='message-label assistant-label';l.textContent='OpenClaw';
    const b=document.createElement('div');b.className='message-body assistant-body';
    const dot=document.createElement('span');dot.className='streaming-dot';b.appendChild(dot);
    w.appendChild(l);w.appendChild(b);chatArea.appendChild(w);scrollDown();
    let full='',aborted=false,activeReader=null;ttsStreamPos=0;ttsAborted=false;
    abortController.signal.addEventListener('abort',()=>{aborted=true;if(activeReader)try{activeReader.cancel();}catch{} stopTTS();});
    try{
      const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:s.conversation}),signal:abortController.signal});
      if(aborted){if(dot.parentNode)dot.remove();w.remove();return;}
      if(!res.ok){let detail;try{const err=await res.json();detail=err.detail||err.error||'Unknown error';}catch{detail=res.statusText||'Request failed';}const errMsg='Error: '+detail;b.innerHTML=fmt(errMsg);s.conversation.push({role:'assistant',content:errMsg});s.rendered.push({role:'assistant',content:errMsg});persist();return;}
      activeReader=res.body.getReader();const dec=new TextDecoder();let buf='';
      while(true){const{done,value}=await activeReader.read();if(done||aborted)break;buf+=dec.decode(value,{stream:true});const lines=buf.split('\n');buf=lines.pop()||'';
        for(const line of lines){if(line.startsWith('data: ')){const p=line.slice(6).trim();if(p==='[DONE]')continue;try{const j=JSON.parse(p);if(j.message?.content){full+=j.message.content;b.innerHTML=fmt(full.replace(ACT_RE_STRIP,'').replace(ACT_RE_STRIP_OLD,'').replace(ACT_RE_PARTIAL,'').trim());if(!b.textContent.trim())b.appendChild(dot);scrollDown();if(!aborted)streamTTSCheck(full,false);}}catch{}}}}
    }catch(e){
      if(aborted){if(!full.trim()){if(dot.parentNode)dot.remove();w.remove();return;}}
      else{full+='\n\n[Connection interrupted: '+e.message+'. Try sending your message again.]';b.innerHTML=fmt(full.replace(ACT_RE_STRIP,'').replace(ACT_RE_STRIP_OLD,'').replace(ACT_RE_PARTIAL,'').trim());scrollDown();}
    }
    if(dot.parentNode)dot.remove();
    if(!full.trim()){if(s.conversation.length<=1)full='Hello! I\'m MiddleClaw, your OpenClaw Bridge assistant. How can I help you today?';else full='I wasn\'t able to generate a response — the conversation may be too long. Try starting a new tab or shortening your last message.';}
    b.innerHTML=fmt(full.replace(ACT_RE_STRIP,'').replace(ACT_RE_STRIP_OLD,'').replace(ACT_RE_PARTIAL,'').trim());
    s.conversation.push({role:'assistant',content:full});
    const entry={role:'assistant',content:full,actions:[]};
    if(!aborted){
      const RE_NEW=new RegExp('\\[ACTION:('+ACT_TYPES+'):([\\s\\S]+?)\\[/ACTION\\]','g');
      const RE_OLD=new RegExp('\\[ACTION:('+ACT_TYPES+'):([^\\]]+)\\]','g');
      let m;
      const CLEAN_TAG=/\[\/ACTION\s*$/;
      function extractAct(m){
        const type=m[1];let target,content;
        const raw=m[2].replace(CLEAN_TAG,'').trimEnd();
        if(type==='WRITE_FILE'||type==='RUN_SCRIPT'){const ci=raw.indexOf(':');if(ci>-1){target=raw.slice(0,ci);content=raw.slice(ci+1).replace(CLEAN_TAG,'').trimEnd();}else{target=raw;content=null;}}else{target=raw;content=null;}
        return {type,target,content,status:'pending',result:null,resultSuccess:null,id:'act_'+Date.now()+'_'+Math.random()};
      }
      function buildCard(act){
        entry.actions.push(act);
        const card=document.createElement('div');card.className='action-card';
        const bc=actBadge(act.type);const tl=actLabel(act.type);
        let ch='<div class="action-header"><span class="action-type-badge '+bc+'">'+tl+'</span><span class="action-target" title="'+esc(act.target)+'">'+esc(act.target)+'</span><button class="action-copy-btn" data-copy="'+esc(act.target)+'" title="Copy"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button></div><div class="action-body">';
        if(act.content)ch+='<div class="action-content-preview">'+esc(act.content)+'</div>';
        ch+='<div class="action-buttons"><button class="btn btn-approve" data-action="approve">✓ Approve</button><button class="btn btn-deny" data-action="deny">✕ Deny</button></div><div class="action-result-container"></div></div>';
        card.innerHTML=ch;w.after(card);wireAct(card,act);
      }
      while((m=RE_NEW.exec(full))!==null){const act=extractAct(m);buildCard(act);}
      const fullLegacy=full.replace(ACT_RE_STRIP,'');
      while((m=RE_OLD.exec(fullLegacy))!==null){const act=extractAct(m);buildCard(act);}
    }
    s.rendered.push(entry);persist();scrollDown();
    if(audioEnabled&&!aborted){const bar=createAudioBar(full);w.appendChild(bar);if(ttsPlaying){currentTTSBar=bar;bar.setPlaying(true);}}
    // Flush any remaining TTS text that didn't hit the 2-sentence threshold
    if(!aborted) streamTTSCheck(full,true);
  }

  function setSendBtnStreaming(on){
    if(on){sendBtn.innerHTML=STOP_ICON;sendBtn.classList.add('stopping');sendBtn.disabled=false;sendBtn.title='Stop';}
    else{sendBtn.innerHTML=SEND_ICON;sendBtn.classList.remove('stopping');sendBtn.disabled=false;sendBtn.title='Send';}
  }

  function startEdit(renderedIdx,originalContent,msgWrap,bodyEl){
    if(streaming)return;
    if(msgWrap.querySelector('.edit-container'))return;
    bodyEl.style.display='none';
    const ec=document.createElement('div');ec.className='edit-container';
    const ta=document.createElement('textarea');ta.className='edit-textarea';ta.value=originalContent;
    ta.rows=Math.min(Math.max(originalContent.split('\n').length,2),8);
    const acts=document.createElement('div');acts.className='edit-actions';
    const notice=document.createElement('div');notice.className='branch-notice';notice.textContent='Editing will branch the conversation from this point';
    const cancelB=document.createElement('button');cancelB.className='btn btn-deny';cancelB.textContent='Cancel';
    const saveB=document.createElement('button');saveB.className='btn btn-approve';saveB.textContent='Save & Submit';
    acts.appendChild(cancelB);acts.appendChild(saveB);
    ec.appendChild(ta);ec.appendChild(notice);ec.appendChild(acts);msgWrap.appendChild(ec);ta.focus();
    const editBtnEl=msgWrap.querySelector('.message-edit-btn');if(editBtnEl)editBtnEl.style.display='none';
    cancelB.addEventListener('click',()=>{ec.remove();bodyEl.style.display='';if(editBtnEl)editBtnEl.style.display='';});
    saveB.addEventListener('click',()=>{const t=ta.value.trim();if(t)submitEdit(renderedIdx,t);});
    ta.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();const t=ta.value.trim();if(t)submitEdit(renderedIdx,t);}
      if(e.key==='Escape'){ec.remove();bodyEl.style.display='';if(editBtnEl)editBtnEl.style.display='';}
    });
  }

  function getConvIdx(s,renderedIdx){
    let ri=0;
    for(let ci=0;ci<s.conversation.length;ci++){
      if(ri>=s.rendered.length)break;
      if(s.conversation[ci].role===s.rendered[ri].role&&s.conversation[ci].content===s.rendered[ri].content){if(ri===renderedIdx)return ci;ri++;}
    }
    return -1;
  }

  async function submitEdit(renderedIdx,newText){
    if(streaming)return;const s=cur();
    const convIdx=getConvIdx(s,renderedIdx);if(convIdx===-1)return;
    s.conversation=s.conversation.slice(0,convIdx);
    s.rendered=s.rendered.slice(0,renderedIdx);
    s.conversation.push({role:'user',content:newText});
    s.rendered.push({role:'user',content:newText});
    if(renderedIdx===0){s.label=newText.length>30?newText.slice(0,30)+'…':newText;renderTabs();}
    persist();renderChat();
    streaming=true;setSendBtnStreaming(true);try{await streamResp();}finally{streaming=false;setSendBtnStreaming(false);}input.focus();
  }

  // ── Audio Feature: Speech-to-Text (MediaRecorder + ElevenLabs Scribe) ──

  const MIC_ICON='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
  const STOP_MIC_ICON='<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';

  let isRecording=false, mediaRecorder=null, mediaStream=null, audioChunks=[], sttBaseText='', sttSkipOnStop=false, sttAutoSend=false;
  let sttWebSocket=null, sttAudioContext=null, sttSourceNode=null, sttScriptNode=null, sttCommittedText='';

  function startLivePreview(){
    sttCommittedText='';
    try{
      const protocol=location.protocol==='https:'?'wss:':'ws:';
      sttWebSocket=new WebSocket(protocol+'//'+location.host+'/ws/stt');

      sttWebSocket.onmessage=function(e){
        try{
          const msg=JSON.parse(e.data);
          if(msg.type==='ready'){startAudioCapture();return;}
          if(msg.error){console.warn('STT WebSocket error:',msg.error);return;}
          if(!isRecording) return;
          if(msg.message_type==='partial_transcript'&&msg.text!==undefined){
            const base=sttBaseText+(sttBaseText?' ':'')+sttCommittedText+(sttCommittedText?' ':'');
            input.value=base+msg.text;
            input.style.height='auto';
            input.style.height=Math.min(input.scrollHeight,160)+'px';
          }else if(msg.message_type==='committed_transcript'&&msg.text){
            sttCommittedText+=(sttCommittedText?' ':'')+msg.text;
            input.value=sttBaseText+(sttBaseText?' ':'')+sttCommittedText;
            input.style.height='auto';
            input.style.height=Math.min(input.scrollHeight,160)+'px';
          }
        }catch{}
      };

      sttWebSocket.onerror=function(){};
      sttWebSocket.onclose=function(){sttWebSocket=null;};
    }catch(e){sttWebSocket=null;}
  }

  function startAudioCapture(){
    if(!mediaStream||!isRecording) return;
    try{sttAudioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16000});}
    catch(e){try{sttAudioContext=new(window.AudioContext||window.webkitAudioContext)();}catch{return;}}
    sttSourceNode=sttAudioContext.createMediaStreamSource(mediaStream);
    sttScriptNode=sttAudioContext.createScriptProcessor(4096,1,1);
    const targetRate=16000;
    const actualRate=sttAudioContext.sampleRate;
    const ratio=actualRate/targetRate;

    sttScriptNode.onaudioprocess=function(e){
      if(!isRecording||!sttWebSocket||sttWebSocket.readyState!==WebSocket.OPEN) return;
      let float32=e.inputBuffer.getChannelData(0);
      // Downsample if AudioContext didn't honor 16kHz
      if(ratio>1.01){
        const newLen=Math.floor(float32.length/ratio);
        const ds=new Float32Array(newLen);
        for(let i=0;i<newLen;i++) ds[i]=float32[Math.floor(i*ratio)];
        float32=ds;
      }
      // Convert Float32 → Int16 PCM
      const int16=new Int16Array(float32.length);
      for(let i=0;i<float32.length;i++){
        const s=Math.max(-1,Math.min(1,float32[i]));
        int16[i]=s<0?s*0x8000:s*0x7FFF;
      }
      // Base64 encode
      const bytes=new Uint8Array(int16.buffer);
      let binary='';
      for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]);
      const base64=btoa(binary);
      sttWebSocket.send(JSON.stringify({message_type:'input_audio_chunk',audio_base_64:base64}));
    };

    sttSourceNode.connect(sttScriptNode);
    sttScriptNode.connect(sttAudioContext.destination);
  }

  function stopLivePreview(){
    if(sttScriptNode){try{sttScriptNode.disconnect();}catch{}sttScriptNode=null;}
    if(sttSourceNode){try{sttSourceNode.disconnect();}catch{}sttSourceNode=null;}
    if(sttAudioContext&&sttAudioContext.state!=='closed'){try{sttAudioContext.close();}catch{}}
    sttAudioContext=null;
    if(sttWebSocket){try{sttWebSocket.close();}catch{}sttWebSocket=null;}
  }

  function updateAudioBtnVisibility(){
    if(audioEnabled) audioBtn.classList.add('visible');
    else { audioBtn.classList.remove('visible'); if(isRecording) stopRecording(); }
  }

  function getSupportedMimeType(){
    const types=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
    for(const t of types) if(MediaRecorder.isTypeSupported(t)) return t;
    return '';
  }

  function startRecording(){
    sttBaseText=input.value;
    isRecording=true;
    audioBtn.innerHTML=STOP_MIC_ICON;
    audioBtn.classList.add('recording');
    audioBtn.title='Stop listening';
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
      if(!isRecording){stream.getTracks().forEach(t=>t.stop());return;}
      mediaStream=stream;
      const mimeType=getSupportedMimeType();
      mediaRecorder=new MediaRecorder(stream, mimeType?{mimeType}:{});
      audioChunks=[];

      mediaRecorder.ondataavailable=e=>{
        if(e.data.size>0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop=async()=>{
        stopLivePreview();
        if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;}

        // If sent while recording, skip all transcription — input was already captured
        if(sttSkipOnStop){sttSkipOnStop=false;audioChunks=[];return;}

        // If realtime WebSocket gave us committed text, use it and skip batch STT
        if(sttCommittedText.trim()){
          input.value=sttBaseText+(sttBaseText?' ':'')+sttCommittedText;
          input.style.height='auto';
          input.style.height=Math.min(input.scrollHeight,160)+'px';
          input.focus();
          audioChunks=[];
          if(sttAutoSend){sttAutoSend=false;input.placeholder='Describe the issue…';input.disabled=false;sendMsg();}
          return;
        }

        // Fallback: send full recording to batch STT
        if(!audioChunks.length){
          if(sttAutoSend){sttAutoSend=false;input.placeholder='Describe the issue…';input.disabled=false;}
          return;
        }

        const mType=mediaRecorder.mimeType||'audio/webm';
        const audioBlob=new Blob(audioChunks,{type:mType});
        audioChunks=[];

        const reader=new FileReader();
        reader.onloadend=async()=>{
          const base64=reader.result.split(',')[1];
          if(!base64) return;

          const prevPlaceholder=input.placeholder;
          input.placeholder='Transcribing…';
          input.disabled=true;

          try{
            const resp=await fetch('/api/stt',{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({audio:base64,mimeType:mType}),
            });
            if(resp.ok){
              const data=await resp.json();
              if(data.text){
                const sep=sttBaseText?' ':'';
                input.value=sttBaseText+sep+data.text;
                input.style.height='auto';
                input.style.height=Math.min(input.scrollHeight,160)+'px';
              }
            }else{
              const err=await resp.json().catch(()=>({}));
              console.warn('STT error:',err.error||'Unknown error');
            }
          }catch(e){console.warn('STT request failed:',e);}

          input.placeholder=prevPlaceholder;
          input.disabled=false;
          input.focus();
          if(sttAutoSend){sttAutoSend=false;sendMsg();}
        };
        reader.readAsDataURL(audioBlob);
      };

      mediaRecorder.start();
      startLivePreview();
    }).catch(err=>{
      isRecording=false;
      stopLivePreview();
      audioBtn.innerHTML=MIC_ICON;
      audioBtn.classList.remove('recording');
      audioBtn.title='Voice input';
      console.warn('Microphone access denied:',err);
    });
  }

  function stopRecording(){
    isRecording=false;
    stopLivePreview();
    audioBtn.innerHTML=MIC_ICON;
    audioBtn.classList.remove('recording');
    audioBtn.title='Voice input';
    if(mediaRecorder&&mediaRecorder.state!=='inactive'){
      mediaRecorder.stop();
    }else{
      if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;}
    }
  }

  audioBtn.addEventListener('click',()=>{
    if(isRecording) stopRecording();
    else startRecording();
  });

  // ── Text-to-Speech via ElevenLabs ──

  let ttsPromises=[], ttsPlaying=false, currentAudio=null, ttsAborted=false, ttsStreamPos=0, currentTTSBar=null;

  function showTTSIndicator(on){
    if(on) ttsIndicator.classList.add('active');
    else{
      ttsIndicator.classList.remove('active');
      if(currentTTSBar){currentTTSBar.setPlaying(false);currentTTSBar=null;}
    }
  }

  async function playNextTTS(){
    if(!ttsPromises.length||ttsAborted){
      ttsPromises=[];ttsPlaying=false;ttsAborted=false;showTTSIndicator(false);return;
    }
    ttsPlaying=true;showTTSIndicator(true);
    const blobPromise=ttsPromises.shift();
    const blob=await blobPromise;
    if(ttsAborted){ttsPromises=[];ttsPlaying=false;ttsAborted=false;showTTSIndicator(false);return;}
    if(!blob){playNextTTS();return;}
    const url=URL.createObjectURL(blob);
    currentAudio=new Audio(url);
    currentAudio.onended=()=>{URL.revokeObjectURL(url);currentAudio=null;playNextTTS();};
    currentAudio.onerror=()=>{URL.revokeObjectURL(url);currentAudio=null;playNextTTS();};
    currentAudio.play().catch(()=>{URL.revokeObjectURL(url);currentAudio=null;playNextTTS();});
  }

  function queueTTS(chunks){
    ttsAborted=false;
    // Fire ALL fetches in parallel so audio is pre-generated while earlier chunks play
    const promises=chunks.map(text=>
      fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})
      .then(r=>r.ok?r.blob():null).catch(()=>null)
    );
    ttsPromises.push(...promises);
    if(!ttsPlaying) playNextTTS();
  }

  function stopTTS(){
    ttsAborted=true;
    ttsPromises=[];
    if(currentAudio){try{currentAudio.pause();}catch{}currentAudio=null;}
    ttsPlaying=false;showTTSIndicator(false);
  }

  ttsStopBtn.addEventListener('click',stopTTS);

  function createAudioBar(content){
    const bar=document.createElement('div');
    bar.className='msg-audio-bar'+(audioEnabled?' visible':'');
    const replayBtn=document.createElement('button');
    replayBtn.className='msg-audio-btn replay-btn';
    replayBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Replay';
    const stopBarBtn=document.createElement('button');
    stopBarBtn.className='msg-audio-btn stop-btn';
    stopBarBtn.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg> Stop';
    stopBarBtn.style.display='none';
    bar.setPlaying=function(on){replayBtn.style.display=on?'none':'';stopBarBtn.style.display=on?'':'none';};
    replayBtn.addEventListener('click',()=>{
      stopTTS();ttsAborted=false;
      currentTTSBar=bar;bar.setPlaying(true);
      const stripped=content.replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'');
      const chunks=parseResponseForTTS(stripped);
      if(chunks.length) fireTTSChunks(chunks);
      else{bar.setPlaying(false);currentTTSBar=null;}
    });
    stopBarBtn.addEventListener('click',()=>stopTTS());
    bar.appendChild(replayBtn);bar.appendChild(stopBarBtn);
    return bar;
  }

  function fireTTSChunks(chunks){
    const promises=chunks.map(text=>
      fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})
      .then(r=>r.ok?r.blob():null).catch(()=>null)
    );
    ttsPromises.push(...promises);
    if(!ttsPlaying) playNextTTS();
  }

  // Called during streaming to send TTS in ~2-sentence chunks as text arrives
  function streamTTSCheck(full,isDone){
    if(!audioEnabled||ttsAborted) return;
    const stripped=full.replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'');
    // Don't process while inside an unclosed code block
    const totalFences=(stripped.match(/```/g)||[]).length;
    if(totalFences%2!==0&&!isDone) return;

    const available=stripped.slice(ttsStreamPos);
    if(!available.trim()&&!isDone) return;

    if(isDone){
      // Flush everything remaining
      if(available.trim()){
        const chunks=parseResponseForTTS(available);
        if(chunks.length) fireTTSChunks(chunks);
      }
      ttsStreamPos=0;
      return;
    }

    // Find a split point: after 2 sentence endings or a paragraph break, outside code blocks
    let sentenceEnds=0,splitAt=-1,codeDepth=0;
    for(let i=0;i<available.length;i++){
      if(available.slice(i,i+3)==='```'){codeDepth=codeDepth?0:1;i+=2;continue;}
      if(codeDepth) continue;
      const c=available[i];
      // Paragraph break
      if(c==='\n'&&i+1<available.length&&available[i+1]==='\n'&&available.slice(0,i).trim()){
        splitAt=i;break;
      }
      // Sentence ending: . or ? or ! followed by space or newline
      if((c==='.'||c==='?'||c==='!')&&i+1<available.length&&(available[i+1]===' '||available[i+1]==='\n')){
        sentenceEnds++;
        if(sentenceEnds>=2){splitAt=i+1;break;}
      }
    }

    if(splitAt>=0){
      const chunk=available.slice(0,splitAt+1);
      ttsStreamPos+=splitAt+1;
      const ttsChunks=parseResponseForTTS(chunk);
      if(ttsChunks.length) fireTTSChunks(ttsChunks);
    }
  }

  function stripMd(s){
    return s
      .replace(/\*\*(.+?)\*\*/g,'$1').replace(/__(.+?)__/g,'$1')
      .replace(/\*(.+?)\*/g,'$1').replace(/(?<!\w)_([^_]+)_(?!\w)/g,'$1')
      .replace(/`([^`]+)`/g,'$1')
      .replace(/^#{1,6}\s+/gm,'')
      .replace(/\[([^\]]+)\]\([^)]+\)/g,'$1')
      .replace(/^\s*[-*]\s+/gm,'').replace(/^\s*\d+\.\s+/gm,'')
      .replace(/[\u{1F000}-\u{1FFFF}|\u{2600}-\u{27BF}|\u{2B50}|\u{FE00}-\u{FE0F}|\u{200D}|\u{20E3}|\u{E0020}-\u{E007F}|\u{2702}-\u{27B0}|\u{1F900}-\u{1F9FF}|\u{1FA00}-\u{1FA6F}|\u{1FA70}-\u{1FAFF}|\u{2194}-\u{2199}|\u{2934}-\u{2935}|\u{25AA}-\u{25FE}|\u{2300}-\u{23FF}|\u{2190}-\u{21FF}|\u{2934}-\u{2935}|\u{23E9}-\u{23F3}|\u{23F8}-\u{23FA}]/gu,'')
      .replace(/[~>|]/g,' ')
      .replace(/\s{2,}/g,' ').trim();
  }

  function parseResponseForTTS(text){
    // Remove action markers
    text=text.replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'').trim();
    if(!text) return [];
    const chunks=[];
    // Split around code blocks
    const parts=text.split(/(```[\s\S]*?```)/g);
    let consecutiveCodeBlocks=0;
    for(let i=0;i<parts.length;i++){
      const part=parts[i].trim();
      if(!part) continue;
      if(part.startsWith('```')){
        consecutiveCodeBlocks++;
      } else {
        // Flush code block announcement
        if(consecutiveCodeBlocks>0){
          chunks.push(consecutiveCodeBlocks===1?'See code block.':'See code blocks.');
          consecutiveCodeBlocks=0;
        }
        // Split into paragraph-sized chunks on double newlines
        const paragraphs=part.split(/\n\n+/);
        for(const p of paragraphs){
          const cleaned=stripMd(p.replace(/\n/g,' ').trim());
          if(cleaned) chunks.push(cleaned);
        }
      }
    }
    // Handle trailing code blocks
    if(consecutiveCodeBlocks>0){
      chunks.push(consecutiveCodeBlocks===1?'See code block.':'See code blocks.');
    }
    return chunks;
  }

  // Fetch audio config on page load
  (async function loadAudioState(){
    try{
      const r=await fetch('/api/config');const cfg=await r.json();
      audioEnabled=!!cfg.audio_enabled;
      localStorage.setItem(AUDIO_KEY,audioEnabled?'true':'false');
      updateAudioBtnVisibility();
    }catch{/* keep localStorage value */}
  })();

  updateAudioBtnVisibility();
  renderTabs();renderChat();input.focus();
})();
</script>
<script>
// Version check to force reload when backend updates frontend
const FRONTEND_VERSION='2026-02-08-05-03';
(function checkVersion(){
  const stored=localStorage.getItem('middleclaw-frontend-version');
  if(stored!==FRONTEND_VERSION){
    localStorage.setItem('middleclaw-frontend-version',FRONTEND_VERSION);
    if(stored){console.log('[MiddleClaw] New version detected, reloading...');location.reload(true);}
  }
})();
</script>
</body>
</html>
